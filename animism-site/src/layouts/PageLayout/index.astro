---
import { getCollection } from 'astro:content';
import Navbar from '../../components/Navbar/index.astro';
import '../../styles/global.css';

/* ── fetch and organise Markdown pages for the navbar ────────── */
const flatPages = await getCollection('pages');

/* keep:
   • top‑level pages   →  "about"
   • second‑level      →  "beliefs/ethics"
   • third‑level only  →  "beliefs/spirits/index"                */
const filteredPages = flatPages.filter((p) => {
  const seg = p.slug.split('/');
  return (
    seg.length <= 2 ||         // top / second
    (seg.length === 3 && seg[2] === 'index') // third‑level index.md
  );
});

/* build a tree so Navbar can render dropdowns */
function nestPages(pages) {
  const tree = {};
  for (const p of pages) {
    const parts = p.slug.split('/');
    const top   = parts[0];
    const rest  = parts.slice(1);

    if (!tree[top]) tree[top] = { title: p.data.title, slug: top, children: [] };

    // second‑level or third‑level index
    if (rest.length === 1 && rest[0] !== 'index') {
      tree[top].children.push({ title: p.data.title, slug: `${top}/${rest[0]}` });
    } else if (rest.length === 2 && rest[1] === 'index') {
      tree[top].children.push({ title: p.data.title, slug: `${top}/${rest[0]}` });
    } else if (rest.length === 0) {
      tree[top].title = p.data.title; // override top title
    }
  }
  return Object.values(tree);
}

const pages = nestPages(filteredPages);
---

<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>My Site</title>
  </head>

  <body>
    <!-- navigation -->
    <Navbar pages={pages} />

    <!-- centred page content -->
    <main class="pageWrapper">
      <article class="pageContent">
        <slot />               <!-- Markdown output -->
      </article>
    </main>
  </body>
</html>

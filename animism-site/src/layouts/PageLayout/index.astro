---
import { getCollection } from 'astro:content';
import Navbar from '../../components/Navbar/index.astro';
import styles from './PageLayout.module.css';
import '../../styles/global.css';

const { noLayout = false } = Astro.props;

const flatPages = await getCollection('pages');

const filteredPages = flatPages.filter((p) => {
  const seg = p.slug.split('/');
  return (
    seg.length <= 2 ||
    (seg.length === 3 && seg[2] === 'index')
  );
});

function nestPages(pages) {
  const tree = {};
  for (const p of pages) {
    const parts = p.slug.split('/');
    const top   = parts[0];
    const rest  = parts.slice(1);

    if (!tree[top]) tree[top] = { title: p.data.title, slug: top, children: [] };

    if (rest.length === 1 && rest[0] !== 'index') {
      tree[top].children.push({ title: p.data.title, slug: `${top}/${rest[0]}` });
    } else if (rest.length === 2 && rest[1] === 'index') {
      tree[top].children.push({ title: p.data.title, slug: `${top}/${rest[0]}` });
    } else if (rest.length === 0) {
      tree[top].title = p.data.title;
    }
  }
  return Object.values(tree);
}

const pages = nestPages(filteredPages);
---

<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>My Site</title>
  </head>

  <body>
    <!-- navigation -->
    <Navbar pages={pages}/>

    <main class={!noLayout ? styles.pageWrapper : ''}>
      <article class={!noLayout ? styles.pageContent : ''}>
        <slot />
      </article>
    </main>
  </body>
</html>
